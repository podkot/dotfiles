#!/usr/bin/env bash


# partially based on https://github.com/paulirish/git-open/blob/master/git-open


origin=$(git remote get-url origin | sed -n 's/\.git$//p')
repo="https://$(echo $origin | sed -n 's/^[^@]*@//p' | sed -n 's/:/\//p')"
branch=$(git status | sed -n 's/On branch //p')

function git-commit-open() {
    commit=$1

    case "$origin" in
        *bitbucket\.org*)   url="$repo/commits/$commit";     ;;
        *)                  url="$repo/commit/$commit";      ;;
    esac;

    browser $url;
}

function git-file-open() {
    filename=$1
    line_from=$2
    line_to=$3
    branch=$branch

    case "$origin" in
        *bitbucket\.org*)   url="$repo/commits/$commit";     ;;
        *)                  url="$repo/commit/$commit";      ;;
    esac;

    browser $url;
}


# get current open browser command
function browser() {
    case $( uname -s ) in
        Darwin)  open=open;;
        MINGW*)  open=start;;
        CYGWIN*) open=cygstart;;
        MSYS*)   open="powershell.exe –NoProfile Start";;
        *)       open=${BROWSER:-xdg-open};;
    esac

    # open it in a browser
    $open "$1" &> /dev/null
    exit $?
}

# find-pr
# https://git.reg.ru/search?group_id=&project_id=&repository_ref=&scope=merge_requests&search=51707
# https://git.reg.ru/search?group_id=&project_id=2&repository_ref=master&scope=merge_requests&search=51707 = project_id мешается
# https://git.reg.ru/search?group_id=&project=regru/srs&repository_ref=master&scope=merge_requests&search=51707 - работает (нет)
# по полной ветке не ищет


git-commit-open $1
